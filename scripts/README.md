# Scripts

Runnable scripts for setup, build, test, lint, and tooling. All are invoked via the **Makefile** (run `make help` at repo root). Scripts may call `package.json` scripts or Code-OSS/VS Code build steps.

## Convention

- **Location:** `./scripts/` (repo root).
- **Invocation:** Prefer `make <target>`; or run `./scripts/<script>` from repo root.
- **Adding a command:** 1) Add script under `scripts/`. 2) Add a Makefile target that runs it. 3) Use `target: ## Short description` so it appears in `make help`.

## Reference

| Make target | Script | Description |
|-------------|--------|-------------|
| **Setup and build** | | |
| `make setup` | `setup.sh` | Install dependencies (Node 22.x). |
| `make build` | `build.sh` | Compile the project (`npm run compile`). |
| `make clean` | `clean.sh` | Remove build artifacts and caches. `make clean ALL=1` also removes `node_modules`. |
| **Tests** | | |
| `make test` | `test.sh` | Full Electron unit tests (requires build + Electron). |
| `make test-unit` | `test-unit.sh` | Fast Node unit tests (no Electron). Optional: `./scripts/test-unit.sh --browser`. |
| `make test-integration` | `test-integration.sh` | Electron integration tests (extensions, API). |
| `make test-web-integration` | `test-web-integration.sh` | Web/browser integration tests (Playwright). |
| `make test-smoke` | `test-smoke.sh` | Smoke tests (`npm run smoketest`). |
| `make test-e2e` | `test-e2e.sh` | E2E/integration (delegates to `test-integration.sh`). |
| `./scripts/test-verify-gates-summary.sh` | `test-verify-gates-summary.sh` | Contract test for `verify-gates` JSON schema and markdown summary rendering using deterministic mocked gate runs, including malformed JSON/CLI-flag error handling (with file-path visibility in warnings), no-op paths (missing summary file / unset step-summary env), summary-file path resolution via env (`VSCODE_VERIFY_SUMMARY_FILE`) and sparse-payload rendering checks (minimal object + scalar/array/null JSON), append behavior checks (multiple publishes append in order), heading sanitization checks (multiline headings collapse to one markdown heading line; mixed whitespace collapses to single spaces; blank headings fall back to `Verify Gates Summary`), verify-gates CLI argument/env validation checks (including `--help` content, unknown-option failure with usage output, missing option values for `--summary-json/--only/--from`, missing/invalid `--retries`, `--only` normalization/duplicate-warning/empty-list errors, `--from` selection/empty-value errors, and continue-on-failure env/flag normalization), markdown escaping checks (table cells + inline code spans such as malformed summary paths and log-file values, including CRLF normalization), fallback-field derivation checks (renderer computes missing maps and gate lists from `gates[]`), result-signature stability checks (same inputs -> same signature, changed selection -> changed signature), schema-warning emission checks (none on current/sparse payloads, exactly one on future-schema payloads), count/partition consistency checks (`statusCounts` and gate-id arrays align with scalar counters), log-file metadata checks (summary path exists + markdown includes log-file line), run/timing metadata checks (`runId`, timestamps, duration, gate-count/list alignment), mode-specific metadata checks (quick vs full run-id prefixes, explicit `--full` dry-run metadata, and default-mode (`--only` without mode flag) full dry-run behavior), step-summary boolean metadata checks (`continueOnFailure`, `dryRun`, `runClassification` rendering), run-classification/exit-reason checks (dry-run, fail-fast, success-with-retries), schema-version synchronization checks across producer/renderer/docs, workflow wiring checks for contract-step presence, and an explicit producer-vs-renderer schema-version sync check. |
| `./scripts/verify-gates.sh` | `verify-gates.sh` | Deterministic validation sweep across lint/typecheck/tests/build with retry support and per-run log/summary output. Use `./scripts/verify-gates.sh --quick` for lighter checks; run with `--help` for options/gate IDs. |
| `./scripts/publish-verify-gates-summary.sh` | `publish-verify-gates-summary.sh` | Append a verify-gates JSON summary to `GITHUB_STEP_SUMMARY` (CI step summaries). Run with `--help` for usage and env details. |
| **Lint and format** | | |
| `make lint` | `lint.sh` | ESLint + Stylelint (no fix). |
| `make fmt` | `fmt.sh` | Apply formatting fixes. |
| `make fmt-check` | `fmt.sh --check` | Check formatting only (no write). |
| `make typecheck` | `typecheck.sh` | TypeScript type checking. |
| `make hygiene` | `hygiene.sh` | Full hygiene (indentation, copyright, lint); pre-commit style. |
| **Tooling** | | |
| `make commit` | `committer` | Atomic commit: `make commit FILES="path1 path2" MSG="feat: description"`. |
| `make import-inspiration` | `import-inspiration-repos.sh` | Clone/update inspiration repos (optional `REPOS="name1 name2"`). |

## For agents and CI

- **Quick checks:** `make setup && make lint && make typecheck && make test-unit`
- **Full gate:** `make build && make test && make test-integration` (and optionally `make test-smoke`).
- **Summary-contract regression check:** run `./scripts/test-verify-gates-summary.sh` (executed in Pointer quality and nightly verify workflows before sweeps).
  - Includes precedence checks for conflicting mode flags (`--quick --full` / `--full --quick`) and retry-source precedence (`VSCODE_VERIFY_RETRIES` default overridden by `--retries`).
  - Includes continue-on-failure failure-path checks (`exitReason=completed-with-failures`, `runClassification=failed-continued`) for both single-failure and multi-failure scenarios, with metadata/partition assertions.
  - Includes non-executed gate exit-code semantics checks (`null` in JSON maps/rows, rendered as `n/a` in markdown table output), including fail-fast fallback derivation for blocked gates.
  - Includes derived-counter fallback checks proving renderer computes pass/fail/skip/not-run/executed counts, retry/pass rates, retry backoff totals/share, duration aggregates, fastest/slowest executed gates, started/completed/total-duration metadata, inferred dry-run/fail-fast/continued-failure run-state metadata (`success`, `continueOnFailure`, `exitReason`, `runClassification`) with explicit `exitReason` precedence when present (unknown explicit reasons are ignored in favor of derived values), boolean-like string normalization for run-state flags (`true/false/1/0/yes/no/on/off`), derived status/non-success/attention gate lists from partition and status-map data, retry-count map fallback from `retriedGateIds`, normalized/sanitized per-gate map handling (retry/duration/attempt/exit-code/not-run-reason maps with known-gate defaults and strict non-negative numeric enforcement), normalized/sanitized scalar metric handling (counts/totals/rates ignore invalid or negative values), normalized/deduplicated gate-id list handling (trim + unique), and `statusCounts` from `gates[]`, gate-id list fields, and explicit status maps when top-level scalar metrics are omitted, plus failed-exit-code derivation in both directions (`failedGateIds` + `gateExitCodeById`, and `failedGateIds` + `failedGateExitCodes`, aligned to failed-gate ordering).
  - Includes explicit run-classification fallback checks proving renderer can derive `success` + `exitReason` when only `runClassification` is present in sparse payloads.
  - Includes conflicting `exitReason`/`runClassification` sparse checks proving explicit `exitReason` wins and conflicting explicit classification is ignored for derived run-state consistency.
  - Includes conflicting run-state flag checks proving contradictory explicit `success`/`dryRun`/`continueOnFailure` values are ignored when explicit `exitReason` establishes authoritative failure semantics.
  - Includes classification-only conflicting-flag checks (including boolean-like string flags) proving contradictory explicit `success`/`dryRun`/`continueOnFailure` values are ignored when explicit `runClassification` establishes authoritative failure semantics.
  - Includes invalid-`exitReason` + explicit-`runClassification` sparse checks proving unknown reasons are ignored while normalized classification still drives `success`/`exitReason` derivation.
  - Includes invalid-`runClassification` + explicit-`exitReason` sparse checks proving unknown classifications are ignored while explicit reason still drives `success`/`continueOnFailure`/classification derivation.
  - Includes dry-run `exitReason` contradiction checks proving conflicting explicit `success`/`dryRun`/`runClassification` values are ignored in favor of dry-run semantics.
  - Includes success/dry-run continue-on-failure checks proving non-failure outcomes derive `continueOnFailure=false` when explicit values are absent, while explicit configured values (including boolean-like strings) remain preserved.
  - Includes classification-driven success contradiction checks proving conflicting explicit `success`/`dryRun` values are ignored while explicit `continueOnFailure` remains visible for non-failure summaries.
  - Includes status-map case/whitespace normalization checks proving sparse `gateStatusById` values are normalized case-insensitively (`PASS`/`FAIL`/`Not-Run`) before derivation.
  - Includes status-map duplicate-key checks proving normalized key collisions resolve deterministically (last-write wins) for status/exit-code map values.
  - Includes duplicate normalized retry/duration/attempt/reason map-key checks proving deterministic last-write behavior is preserved across all per-gate map inputs.
  - Includes gate-row status/ID case+whitespace normalization checks proving sparse `gates[].status` values are normalized case-insensitively and `gates[].id` values are trimmed + deduplicated before counter/list/table derivation.
  - Includes gate-row not-run-reason trimming checks proving sparse `gates[].notRunReason` values are whitespace-normalized in both map metadata and table rendering.
  - Includes gate-row not-run-reason type checks proving non-string `gates[].notRunReason` values are sanitized to `null`/`n/a` in derived metadata and table output.
  - Includes gate-row command-type checks proving non-string/empty `gates[].command` values are sanitized to `unknown` in table output without affecting gate-ID derivation.
  - Includes gate-row numeric-field sanitization checks proving invalid `attempts`/`retryCount`/`retryBackoffSeconds`/`durationSeconds`/`exitCode` values are normalized to safe defaults (`0`/`n/a`) for row rendering and derived maps.
  - Includes timestamp-whitespace normalization checks proving padded `startedAt`/`completedAt` values (including selected no-row scope metadata) are trimmed before duration/start/end derivation.
  - Includes timestamp-canonicalization checks proving malformed calendar timestamps (invalid month/day combinations, invalid hour/minute/second fields, and non-leap-century day overflows like `19000229`) are ignored, malformed explicit unscoped timestamps fall back to canonical row-derived start/end metadata (or `unknown` when no rows exist), padded explicit unscoped timestamps are trimmed before derivation, valid leap-day timestamps (including century leap years like `20000229`) and valid day/year-boundary ranges remain accepted for selected no-row derivation, and conflicting selected-scope or unscoped no-row timestamps avoid negative derived durations (`Total duration: unknown`) unless an explicit total-duration scalar is present, while explicit selected duration-map evidence with zero values still preserves deterministic `Total duration: 0s`.
  - Includes selected no-row duration-map scoping checks proving non-selected `gateDurationSecondsById` entries are scoped out before selected duration precedence decisions, preserving explicit selected `totalDurationSeconds` when present and keeping duration `unknown` when selected duration-map evidence and explicit totals are both absent.
  - Includes selected unmatched-row malformed-explicit timestamp checks proving fallback table rows do not seed selected-scope `Started`/`Completed`/`Total duration` metadata when explicit selected-scope timestamps are malformed (timing remains `unknown`).
  - Includes malformed gate-row checks proving non-object/invalid rows are ignored for derived counters/lists/table rows while valid normalized rows still render correctly.
  - Includes duplicate gate-row checks proving row-derived gate counters stay aligned with deduplicated normalized gate IDs (no double-counted pass/fail totals).
  - Includes duplicate conflicting-status row checks proving status precedence is deterministic for repeated IDs (`fail` > `pass` > `skip` > `not-run`) across counters/lists/maps.
  - Includes duplicate conflicting-status exit-code checks proving per-gate maps (e.g., `gateExitCodeById`/failed exit-code lists) are derived from status-precedence-resolved rows rather than raw row order.
  - Includes duplicate-row table checks proving markdown rows are rendered from one precedence-resolved row per gate ID (no duplicate gate rows with conflicting statuses).
  - Includes equal-status duplicate row checks proving deterministic tie-breaking (latest row wins) for per-gate map/table values when repeated IDs share the same canonical status.
  - Includes explicit selected-gate order checks proving table row ordering follows normalized `selectedGateIds` (trim + dedupe + string-only) when sparse payloads provide both row data and explicit selection order.
  - Includes selected-gate missing-row checks proving explicit `selectedGateIds` metadata is preserved even when some selected gates have no row data (table renders only matched selected rows; missing/non-selected rows are omitted).
  - Includes selected-gate missing-row map-default checks proving missing selected gates still appear in per-gate maps with safe defaults (`unknown` status, `null` exit code, zero-valued retry/duration/attempt fields).
  - Includes selected-gate missing-row visibility checks proving missing selected IDs surface in non-success/attention lists even when table rows are unavailable.
  - Includes row-derived map-default parity checks proving missing selected gates receive safe defaults in row-derived maps too (`null`/`0`), not just explicit summary maps.
  - Includes selected-gate unmatched-row table fallback checks proving table rendering falls back to available rows when explicit `selectedGateIds` match no row IDs, while counters/maps remain selected-scope based.
  - Includes explicit empty selected-gate checks proving `selectedGateIds: []` keeps counters/maps empty and renders the placeholder table row (no fallback rows).
  - Includes selected-gate subset-row checks proving counters/non-success lists, per-gate maps (status/exit/retry/duration/attempt), and table rendering all scope to explicit selected IDs when at least one selected row exists.
  - Includes explicit empty non-success/attention list checks proving `nonSuccessGateIds: []` and `attentionGateIds: []` remain authoritative even when row-derived statuses include failures, while explicit empty unscoped `nonSuccessGateIds` still allows explicit retried-gate evidence to surface in attention fallback and explicit empty unscoped `attentionGateIds` remains authoritative even when explicit retried-gate evidence exists.
  - Includes selected-gate status-map scope checks proving summary-provided status/per-gate maps, scalar failure metadata (`failedGateId`, `failedGateExitCode`, `blockedByGateId`), scalar slow/fast metadata (`slowestExecutedGateId`, `fastestExecutedGateId` + durations), start/end timestamps (`startedAt`, `completedAt`, ignored when selected rows exist but preserved when selected scope has no matched rows; malformed selected row timestamps produce `unknown` start/end while still deriving duration from selected row duration evidence), failed exit-code list alignment (`failedGateIds` + `failedGateExitCodes`, with ambiguous exit-code lists ignored when IDs are absent), scalar-failure-only fallback behavior (`failedGateId` contributes selected failed-gate count/list evidence when partition lists are absent, while explicit empty unscoped failed-gate lists can retain zero failed-count metadata and still project scalar failed-gate list/pointer fallback), scalar-blocked-only fallback behavior (`blockedByGateId` contributes fail-fast/run-state conflict evidence when partition lists are absent, while non-selected blocked IDs are scoped out), selected not-run blocked-reason behavior (selected `blocked-by-fail-fast:<id>` reasons override conflicting explicit success run-state metadata to fail-fast; non-selected blocked-reason IDs do not affect blocked-by run-state metadata; blocked-reason values require selected gate `not-run` evidence, with status-map values taking precedence over fallback partition lists and blocked-by reason IDs whitespace-normalized before selected-scope matching; blank blocked IDs and `none` sentinel blocked IDs are ignored; `blocked-by-fail-fast:` prefix parsing is case-insensitive and tolerates optional whitespace before `:`; when selected status-map values are unknown placeholders, selected not-run partition lists can still establish blocked-reason eligibility; when multiple selected blocked reasons exist, selected gate order determines blocked-by precedence unless explicit scalar `blockedByGateId` is provided, which remains authoritative), scalar blocked-by normalization behavior (scalar `blockedByGateId` values are also trimmed before selected-scope matching, and blank scalar blocked IDs are ignored), selected non-success partition fallback behavior (when selected status-map entries are missing, selected `failed/skipped/not-run` partition lists still drive non-success derivation, while explicit selected status-map values still take precedence over fallback partition memberships), selected attention retried fallback behavior (selected retried gates are retained in attention lists even when selected non-success list is empty, while non-selected retried IDs are scoped out, and retry aggregate totals/backoff remain scoped to selected retried IDs even when retry-count maps are omitted), selected explicit attention/non-success list scoping behavior (explicit `attentionGateIds` / `nonSuccessGateIds` are trimmed and scoped to selected IDs, explicit empty attention lists remain authoritative even when selected retried gates exist, explicit empty retried-gate lists remain authoritative for retry aggregates even when selected retry-count maps are present, explicit retried subset lists constrain retry aggregates to listed gates when retry-count maps contain additional gate IDs, explicit retried subset lists also override row-derived retry counts for non-retried selected gates, explicit retried-gate IDs with zero/missing retry-count map values are promoted to minimum retry count `1` for aggregate consistency in both selected and unscoped summaries, explicit retried-gate IDs missing from retry-count maps are synthesized into normalized retry-count maps, retry-count map entries outside explicit retried lists are normalized to `0` for consistency, explicit retried IDs fully scoped out by `selectedGateIds` collapse to empty retried metadata with zero retry-count maps/aggregates, fallback unscoped selected-gate derivation now includes explicit partition/retried/attention lists and scalar failed/blocked gate IDs when row/status-map evidence is absent, scalar `failedGateId`/`blockedByGateId` values equal to `none` (including case/whitespace variants) are treated as sentinels (ignored) instead of synthesized gate IDs, selected explicit retried IDs missing from retry-count maps are synthesized while selected non-retried map entries are zeroed for aggregate consistency, scalar slow/fast gate IDs equal to sentinels suppress corresponding scalar duration overrides, scalar blocked-only fallback can preserve explicit success run-state metadata in unscoped sparse payloads without conflicting outcome evidence, and explicit empty non-success lists still allow selected retried gates to surface in derived attention fallback), fail-fast continue-flag conflict handling (`continueOnFailure: true` is ignored when selected fail-fast evidence is present, including both scalar and row-derived blocked evidence), fail-fast dry-run conflict handling (`dryRun: true` is ignored when selected fail-fast evidence is present), fail-fast explicit dry-reason/classification conflict handling (explicit `exitReason: dry-run` / `runClassification: dry-run` is ignored when selected fail-fast evidence is present for both scalar and row-derived blocked evidence), and fail-fast vs continued-failure conflict handling (explicit `completed-with-failures` / `failed-continued` is ignored when selected fail-fast evidence is present for both scalar and row-derived blocked evidence), run-state scalars (`success`, `dryRun`, `continueOnFailure`, `exitReason`, `runClassification`) when they conflict with selected-scope evidence (including explicit success-over-failure conflicts; but preserved when selected scope lacks outcome evidence, including unmatched-selection rows, scoped-out non-selected map/list evidence, unresolved `unknown` selected statuses, partial selected-status coverage, and non-executed-only selected evidence), conflicting scalar/status counters (`gateCount`, `passed/failed/skipped/not-run/executed`, `statusCounts`)—including selected no-evidence payloads where conflicting selected scalar/status counters are fully ignored back to zero, selected status-map-evidence payloads where conflicting scalar/raw counters (including partially malformed raw status-count branches, malformed selected status-map status values dropped before partition fallback, partial status-map + partition fallback blends including explicit-zero scalar/raw status-count bundles, and explicit zero raw `statusCounts` bundles) are ignored in favor of selected status-map/partition projections, and selected partition-evidence payloads where conflicting raw `statusCounts` plus mixed scalar counter bundles (including explicit zero raw `statusCounts` bundles and partially malformed raw status-count branches) remain ignored in favor of selected partitions—and conflicting aggregate metrics (`retried/total-retry`, duration totals/averages, retry/pass/share rates, `totalDurationSeconds`—except no-row/no-duration fallback preservation, selected no-row duration-map precedence (including zero-valued maps) over conflicting explicit total-duration scalars, and explicit selected no-row total-duration preservation when no selected duration-map evidence exists) are filtered/ignored to preserve explicit `selectedGateIds` scope.
  - Includes overlapping partition-list normalization checks proving sparse `passedGateIds`/`failedGateIds`/`skippedGateIds`/`notRunGateIds` memberships collapse to a single highest-priority status (`fail` > `pass` > `skip` > `not-run`) before counters, status maps, rendered partition lists, and sparse executed-gate fallback metadata are derived (in both selected and unscoped payloads, including explicit empty status-map objects and partial status-map + partition merge cases where missing status-map keys still derive executed fallback from partitions, explicit empty selected partition-list overrides that keep partition counts/lists at zero while selected status-map evidence still drives executed/non-success projections, explicit empty unscoped partition-list overrides with the same count/list-zero + status-map projection behavior, explicit empty unscoped `executedGateIds` overrides that keep executed count/list authoritative at zero, malformed selected list payloads where trimmed/deduped/scoped partition + executed/retried/non-success/attention lists stay aligned while conflicting selected scalar counters remain ignored, malformed unscoped list/count bundles where invalid scalar counters/raw statusCounts are ignored in favor of normalized sparse partition/retry evidence, and mixed valid+malformed unscoped `statusCounts` payloads where valid fields stay authoritative while malformed siblings fall back per field).
  - Includes selected explicit executed-list override checks proving `executedGateIds: []` remains authoritative (executed count/list stay zero/none and executed-rate metrics render `n/a`) even when selected pass/fail partition and retry evidence exists, conflicting selected integer or numeric-string `executedGateCount` scalars are ignored under explicit selected scope, explicit non-empty selected executed lists remain authoritative for executed-count/rate derivation even when conflicting selected integer or numeric-string `executedGateCount` scalars (including normalized zero scalar inputs) are provided, partial selected status-map+partition executed fallback (when executed lists are omitted) suppresses conflicting selected `executedGateCount` scalars (including integer non-zero plus normalized numeric-string non-zero and zero scalar inputs), conflicting selected raw `statusCounts` executed branches (including zero/non-zero integer and numeric-string raw executed-count projections and partially malformed raw status-count bundles), and combined selected scalar-plus-raw status-count conflicts (integer and numeric-string scalar forms, including normalized numeric-string zero scalar inputs), while selected status-map precedence over conflicting selected partition memberships (including pass/fail/skip/not-run-vs-other-status conflicts) still drives executed metadata/rates.
  - Includes unscoped explicit empty retried-list override checks proving `retriedGateIds: []` remains authoritative (retried count/list/aggregates and retry-count map entries normalize to zero) even when unscoped retry-count map inputs contain positive values.
  - Includes malformed selected aggregate-metric checks proving invalid selected-scoped retry/duration/rate scalars (`retriedGateCount`, `totalRetryCount`, `totalRetryBackoffSeconds`, `executedDurationSeconds`, `averageExecutedDurationSeconds`, `retryRatePercent`, `retryBackoffSharePercent`, `passRatePercent`) are ignored and re-derived from selected retry/duration map evidence (or normalized to zero/`n/a` no-evidence fallbacks when selected retry/duration inputs are absent), numeric-string/decimal-string/scientific-notation/non-integer/plus-prefixed/overflow-percentage aggregate scalars are still ignored under explicit selected scope (including selected no-evidence payloads, explicit selected overflow-rate no-evidence payloads, mixed boundary+overflow selected-rate no-evidence payloads in both numeric and numeric-string encodings, mixed-invalid scalar bundles, and valid boundary `0%` selected-rate scalar payloads), and selected aggregates remain scoped even when only non-selected execution/retry/duration evidence exists.
  - Includes unscoped aggregate-metric scalar precedence checks proving valid unscoped retry/duration/rate scalars (including trimmed numeric-string scalars in sparse no-evidence payloads and inclusive `0%`/`100%` boundary rate scalars) override derived map/list totals, valid unscoped partition-count scalars (`passed/failed/skipped/not-run`) stay authoritative over conflicting sparse partition list lengths and conflicting valid raw `statusCounts` fields for count lines, mixed explicit/malformed scalar payloads resolve per field (explicit values preserved where valid while malformed fields re-derive, including mixed boundary + overflow percentage scalar bundles in both evidence-backed and sparse no-evidence payloads, plus explicit integer/numeric-string `executedGateCount` scalar overrides over empty `executedGateIds` lists, combined integer/numeric-string zero/non-zero `executedGateCount` scalar + raw `statusCounts` bundles over explicit empty `executedGateIds` lists remaining deterministic (raw status-count pass/fail counters stay authoritative while executed-count/rate metrics follow the scalar denominator, including normalized numeric-string zero scalar handling), explicit zero integer/numeric-string `executedGateCount` scalar overrides over non-empty `executedGateIds` lists while rate fields render `n/a`, combined integer/numeric-string zero/non-zero `executedGateCount` scalar + raw `statusCounts` bundles over explicit non-empty `executedGateIds` lists remaining deterministic (raw status-count pass/fail counters stay authoritative while executed-count/rate metrics follow the scalar denominator and explicit executed-list labels remain visible), explicit zero integer/numeric-string `executedGateCount` scalar overrides over sparse status-map/partition executed fallback while executed-list labels remain visible and executed-rate metrics render `n/a`, explicit non-zero integer and numeric-string `executedGateCount` scalar overrides over sparse status-map/partition executed fallback while implicit executed-list labels remain visible and executed-rate metrics use the scalar denominator, combined integer/numeric-string executed-count scalar + raw `statusCounts` bundles remaining deterministic (raw status-count pass/fail counters stay authoritative while executed-count/rate metrics follow the scalar denominator, including normalized numeric-string zero scalar and integer zero-scalar cases), mixed per-field scalar/raw/list/status-map status-count precedence branches, malformed partition-count scalar fallback to valid raw `statusCounts`, partial raw status-count fallback to status-map/list evidence when raw fields are missing/malformed, explicit zero raw `statusCounts` fields remaining authoritative even when sparse status-map evidence is present, explicit zero raw `statusCounts` map values remaining authoritative even when conflicting valid partition-count scalars drive count lines, and mixed scalar + partial zero-raw status-count branches where unresolved fields still fall back per status key), malformed unscoped scalar values (including negative numeric inputs, decimal/scientific-notation/plus-prefixed numeric-string inputs, non-integer numeric inputs, >100 percentage scalars, and mixed-invalid sparse scalar bundles) are ignored and safely re-derived from retry/duration map evidence (or normalized to zero/`n/a` no-evidence fallbacks when retry/duration inputs are absent), and derived percentage metrics are clamped to `100%` when conflicting sparse counts would otherwise exceed logical percentage bounds (including scalar-count conflicts like `retriedGateCount > executedGateCount`).
  - Includes invocation-whitespace checks proving blank/whitespace `invocation` values normalize to `unknown` in rendered metadata.
  - Includes run/signature/log metadata whitespace checks proving blank `runId`/signature fields normalize to `unknown`, blank `logFile` is suppressed, and invalid slow/fast metadata falls back to derived `n/a` values.
  - Includes run/signature/log metadata non-string checks proving non-string `runId`/signature/log-file values are sanitized (`unknown`/suppressed) instead of rendered raw.
  - Includes slow/fast metadata string checks proving gate IDs are trimmed and duration strings are parsed as integers for rendered `slowest/fastest` lines.
  - Includes schema-version normalization checks proving numeric strings (e.g. `" 99 "`) are parsed for warning logic while non-numeric or non-positive versions (e.g. `"v99"`, `0`) fall back to `unknown` without warning.
  - Includes duplicate unknown-status row checks proving invalid duplicate statuses do not pollute non-success/attention lists when a canonical status already resolves the gate.
  - Includes unknown-status-only row checks proving unresolved row statuses render as `unknown` and still surface in non-success/attention lists for operator visibility.
  - Includes unknown-status row-table checks proving unresolved row status tokens are normalized to `unknown` in markdown table output (no raw unknown-status leakage).
  - Includes numeric-boolean normalization checks proving `success`/`dryRun`/`continueOnFailure` accept numeric `1`/`0` encodings while unsupported numeric values are ignored.
- **One-command sweep:** `./scripts/verify-gates.sh` (or `./scripts/verify-gates.sh --quick`).
- **Retry and logs:** set `VSCODE_VERIFY_RETRIES=<n>` (or `--retries <n>`), logs are written to `.build/logs/verify-gates/` (override via `VSCODE_VERIFY_LOG_DIR`).
- **Failure strategy:** default is fail-fast; set `VSCODE_VERIFY_CONTINUE_ON_FAILURE=1` (also accepts `true/yes/on`) or pass `--continue-on-failure` to run all selected gates before returning a failing exit code.
- **Machine-readable summary:** each run also writes `<mode>-<timestamp>.json`; override with `--summary-json <path>` or `VSCODE_VERIFY_SUMMARY_FILE`.
  - Current summary schema version: `18`.
  - Summary payload includes `schemaVersion`, `runId`, `runClassification`, `resultSignatureAlgorithm`, `resultSignature`, `exitReason`, `invocation`, `startedAt`, `completedAt`, `totalDurationSeconds`, `continueOnFailure`, `dryRun`, `gateCount`, `passedGateCount`, `failedGateCount`, `skippedGateCount`, `notRunGateCount`, `statusCounts`, `gateStatusById`, `gateExitCodeById`, `gateRetryCountById`, `gateDurationSecondsById`, `gateNotRunReasonById`, `gateAttemptCountById`, `executedGateCount`, `totalRetryCount`, `totalRetryBackoffSeconds`, `retriedGateCount`, `retriedGateIds`, `retryRatePercent`, `retryBackoffSharePercent`, `passRatePercent`, `executedDurationSeconds`, `averageExecutedDurationSeconds`, `slowestExecutedGateId`, `slowestExecutedGateDurationSeconds`, `fastestExecutedGateId`, `fastestExecutedGateDurationSeconds`, `failedGateId`, `failedGateExitCode`, `blockedByGateId`, `failedGateIds`, `failedGateExitCodes`, `passedGateIds`, `skippedGateIds`, `executedGateIds`, `notRunGateIds`, `nonSuccessGateIds`, `attentionGateIds`, plus per-gate `status`, `attempts`, `retryCount`, `retryBackoffSeconds`, `durationSeconds`, `exitCode`, `startedAt`, `completedAt`, and `notRunReason` (`null` when not applicable; fail-fast blockers are tagged as `blocked-by-fail-fast:<gate-id>`).
  - Non-executed gates (`skip`/`not-run`) emit `exitCode: null` in both `gates[]` and `gateExitCodeById`; executed gates (`pass`/`fail`) emit integer exit codes.
  - `runClassification` values: `dry-run`, `success-no-retries`, `success-with-retries`, `failed-fail-fast`, `failed-continued`.
- **GitHub step summary helper:** use `./scripts/publish-verify-gates-summary.sh` to render the JSON payload into markdown for CI run summaries.
  - The helper is fail-safe for CI `if: always()` steps: malformed/missing payload fields are rendered as warnings/placeholders instead of failing the workflow step.
  - Rendered metadata includes run mode context (`dryRun`, gate count, selected gates, failed gate) for faster CI triage.
  - Summary values are markdown-escaped to keep tables readable when commands/IDs contain special characters (pipes/backticks/newlines).
  - Rendered per-gate table includes retries/backoff and command exit code for faster root-cause triage.
  - Failed/not-run/retry metadata includes exit reason, first-failure pointers, blocking gate ID for fail-fast runs, complete failed/not-run/retried gate lists, and per-gate not-run reasons.
  - The rendered `Gate not-run reason map` is compacted to non-null entries (`none` when empty) for cleaner fail-fast diagnostics.
  - Both helper scripts print usage and exit non-zero on unknown flags/missing required option values.
- **Gate selection:** resume from a specific gate with `--from <gate-id>` or run a subset with `--only gate1,gate2`.
- **Dry-run planning:** use `--dry-run` to validate gate selection/filtering and emit summary/log metadata without executing gates.
  - `--only` tolerates whitespace and automatically ignores duplicate gate IDs.
  - Gate IDs: `lint`, `typecheck`, `test-unit`, `test`, `test-smoke`, `test-integration`, `test-e2e`, `test-web-integration`, `build`.
- **Before commit:** `make lint`, `make fmt-check` or `make hygiene`, `make typecheck`, then `make commit FILES="..." MSG="..."`.

## Linux headless stability note

- Electron test/smoke launchers auto-apply `--disable-dev-shm-usage` on Linux to reduce `/dev/shm` exhaustion failures in container/headless environments.
- To intentionally disable this mitigation for local experiments, set:
  - `VSCODE_TEST_DISABLE_DEV_SHM_WORKAROUND=1`
- Test launchers also auto-fallback to `xvfb-run -a` when Linux display detection fails (`DISPLAY` missing or points to a dead X server), so default `make test`, `make test-smoke`, and integration flows can run in headless VMs without manual wrapping.
- To bypass the internal xvfb re-exec guard (mainly for debugging launcher behavior), set:
  - `VSCODE_SKIP_XVFB_WRAPPER=1`
- Applies to:
  - `make test` (`scripts/test.sh`)
  - `make test-smoke` (`scripts/test-smoke.sh`)
  - integration extension launches via `scripts/code.sh`
  - smoke/electron automation launches (`test/automation/src/electron.ts`)
- `scripts/test.sh`, `scripts/code.sh`, and `scripts/test-smoke.sh` share launcher resilience helpers from `scripts/electron-launcher-utils.sh`:
  - auto-fallback to `xvfb-run -a` when `DISPLAY` is missing/stale (Linux)
  - binary preflight check that first attempts `chmod +x` recovery, then does a one-time `npm run electron` retry when Electron binary is missing/non-executable.

Scripts are documented at the top of each file (purpose, usage, and what they delegate to).
